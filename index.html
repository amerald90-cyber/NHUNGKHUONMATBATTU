<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dự Án Những Gương Mặt Bất Tử - Hành Trình Số</title>
    
    <!-- CHỐNG CACHE -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/263/263062.png" type="image/png">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden; 
            background-color: #240046; 
        }
        iframe {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* NÚT LOA ĐIỀU KHIỂN */
        #music-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 9999;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none; /* Ẩn cho đến khi load được nhạc */
        }
        #music-icon {
            width: 25px;
            height: 25px;
            filter: invert(1);
        }
        .is-playing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
    </style>
</head>
<body>

    <!-- NÚT LOA -->
    <div id="music-btn" onclick="toggleMusic()">
        <img id="music-icon" src="https://cdn-icons-png.flaticon.com/512/727/727269.png" alt="Play">
    </div>

    <!-- NHẠC NỀN -->
    <audio id="bgMusic" loop></audio>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwsiZW2nFBAILkM_uZfYgBFEr1Hq_KEgOo3XQ1SGBtvmGKUsLKmMiLWLak8107Cj2bD/exec?ver=update_new";
        var audio = document.getElementById('bgMusic');
        var btn = document.getElementById('music-btn');
        var icon = document.getElementById('music-icon');

        // Hàm chuyển đổi link Google Drive sang link chạy trực tiếp
        function formatDriveLink(link) {
            if (link.includes('drive.google.com')) {
                let id = link.split('/d/')[1]?.split('/')[0] || link.split('id=')[1]?.split('&')[0];
                return `https://docs.google.com/uc?export=download&id=${id}`;
            }
            return link;
        }

        // TỰ ĐỘNG LẤY NHẠC TỪ SHEET
        async function loadMusicFromSheet() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                // Tìm dòng có tiêu đề là "NHẠC"
                const musicData = data.find(item => item.name === "NHẠC" || item.title === "NHẠC");
                
                if (musicData) {
                    // Lấy link từ cột chứa nội dung (thường là musicData.link hoặc musicData.content tùy cấu trúc Sheet của bạn)
                    let rawLink = musicData.link || musicData.content || musicData.url;
                    if (rawLink) {
                        audio.src = formatDriveLink(rawLink);
                        btn.style.display = "flex"; // Hiện nút nhạc khi đã có link
                        console.log("Đã tìm thấy bài hát dự án!");
                    }
                }
            } catch (e) {
                console.log("Không thể kết nối Sheet để lấy nhạc:", e);
            }
        }

        function toggleMusic() {
            if (audio.paused) {
                audio.play();
                btn.classList.add('is-playing');
                icon.src = "https://cdn-icons-png.flaticon.com/512/727/727269.png"; 
            } else {
                audio.pause();
                btn.classList.remove('is-playing');
                icon.src = "https://cdn-icons-png.flaticon.com/512/3103/3103443.png"; 
            }
        }

        // Kích hoạt nhạc khi chạm lần đầu
        document.addEventListener('click', function() {
            if (audio.paused && audio.src) {
                audio.play();
                btn.classList.add('is-playing');
            }
        }, { once: true });

        // Khởi chạy lấy dữ liệu
        loadMusicFromSheet();
    </script>

    <iframe 
        src="https://script.google.com/macros/s/AKfycbwsiZW2nFBAILkM_uZfYgBFEr1Hq_KEgOo3XQ1SGBtvmGKUsLKmMiLWLak8107Cj2bD/exec?ver=update_new" 
        title="Những Gương Mặt Bất Tử"
        allow="camera; microphone; autoplay; clipboard-write; encrypted-media; picture-in-picture" 
        allowfullscreen>
    </iframe>

</body>
</html>